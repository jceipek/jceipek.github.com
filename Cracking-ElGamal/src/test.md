<link rel="stylesheet" type="text/css" href="stylesheets/normalize.css">
<link rel="stylesheet" type="text/css" href="stylesheets/main.css">
<link rel="stylesheet" type="text/css" href="stylesheets/TangleKit.css">
<script data-main="javascripts/main" src="javascripts/3rdparty/require.js"></script>
<script type="text/javascript" src="javascripts/3rdparty/TangleKit/sprintf.js"></script>

# Cracking ElGamal for fun and profit

<small>Julian Ceipek, Mar 10, 2014</small>

*ElGamal* is an _asymmetric encryption algorithm_ used to securely exchange messages over long distances. Unfortunately, if the message being encrypted is short enough, the algorithm is susceptible to a *Meet in the Middle attack*. In this [reactive document](http://worrydream.com/ExplorableExplanations/), we'll look at how *ElGamal* works and how to break it in order to steal a fraction of the credit card numbers sent to a hypothetical web store called _Alice Inc._

{.js-example-example}
Since this is a reactive document, make sure to experiment with the <span class='FakeAdjustableNumber'><span>adjustable values</span> </span> in the examples to make sure you understand them. For example, the factors of %%n=%%
<span class='TKAdjustableNumber' data-var="exampleN" data-min="2" data-max="99999"> </span>
are
{<span data-var="exampleFactors"><span>}.

## ElGamal

The objective of encryption algorithms is to help people share secret or sensitive information with one another by using the information equivalent of physical keys. To make the discussion easier to follow, we say that Bob wants to send Alice a message without Eve ever being able to see it. With a _symmetric encryption algorithm_, the key used to encrypt a message is the same as the key used to decrypt it. This is analogous to Bob putting his message in a box, locking it, and sending it to Alice to unlock. A big problem with this approach is that Alice needs a copy of the key that Bob used. This is a chicken and egg problem: in order to securely exchange information with one another in this way, Alice and Bob must already have exchanged secret information. If Bob ever sends a key to Alice, Eve can easily intercept it and use it to read his messages. In theory, Bob could give Alice a key in person, but that doesn't work well in practice. Imagine having to drive to Amazon's offices in order to give them your credit card number before you could buy something online. Inconceivable!

The solution can be found with _asymmetric encryption algorithms_, which don't use the same key for encryption and decryption. Continuing our analogy of boxes and physical keys, Alice sends an unlocked lock to everyone who wants to send messages to her. Bob puts his message in a box, locks it with Alice's lock, and sends it back to Alice. Since Alice is the only one with the key to the lock, only she can read the message once it is in the locked box. *ElGamal* is an example of an information algorithm that works on this principle.

### Background Theory: Modulo, Subgroups, and Cycles

Before we can explore ElGamal, we need to understand some of the principles that are involved.

~~~ {.example.js-modulo-example}

## Modulo: What and Why?

The %%modulus%% operator is an integral part of many encryption systems. For positive numbers, %%a \bmod b%% computes the remainder after dividing %%a%% by %%b%%, which ensures that the result is between %%0%% and %%b-1%%. Try it out:

{.center-example}
<span class="TKAdjustableNumber" data-var="moduloA" data-min="-100" data-max="100"></span>
%% \bmod %%
<span class="TKAdjustableNumber" data-var="moduloB" data-min="-100" data-max="100"></span>
%% = %%
<span data-var="moduloRes"></span>

The aspect of modulo that makes it so useful for encryption algorithms is that the result of %%a \bmod b%% doesn't reveal any information about %%a%%.

{.js-modulo-example-possibly-broken}
The result
<span data-var="moduloRes"> </span>
could just as easily be
<span data-var="moduloALookalike"> <span> </span></span> %% \bmod %% <span data-var="moduloB"></span>
as <span data-var="moduloA"> <span> </span></span> %% \bmod %% <span data-var="moduloB"></span>. We say <span data-var="moduloA"> <span> </span></span> and <span data-var="moduloALookalike"></span> are congruent modulo <span data-var="moduloB"></span>:

{.js-modulo-example-possibly-broken.center-example}
<span data-var="moduloA"></span> %% \equiv %% <span data-var="moduloALookalike"></span> (%% \bmod %% <span data-var="moduloB"></span>)

Conveniently for cryptography purposes (encryption algorithms deal with very large numbers), the operator distributes over multiplication, addition, and subtraction.

Read more about modular arithmetic on <a href="http://en.wikipedia.org/wiki/Modular_arithmetic" target="_blank">Wikipedia</a>.

~~~


~~~ {.example.js-subgroup-example}

## Finite Cyclic Groups and Subgroups

A _cyclic group_ is a mathematical group generated by one of the elements in the group, %%g%%. As far as *ElGamal* is concerned, we are only interested in two types of groups:

* The group of integers from %%1%% to %%p-1%% under multiplication %%\pmod{p}%% for some prime number %%p%%, which is known as %%\mathbb{Z}_p^*%%

* The subgroups of %%\mathbb{Z}_p^*%% of prime order

If %%p=%% <span class="TKAdjustableNumberWithDataSource" data-var="primeP primes" data-min="3" data-max="100"></span>, the factors of %%p-1=%% <span data-var="pminusOne"> </span> are {<span data-var="factors"></span>}.

The integer <span data-var="fullGenerator"> </span> is the smallest generator %%g%% for the full group of order %% n = p-1 = %% <span data-var="pminusOne"> </span> containing all the elements from 1 to <span data-var="pminusOne"></span>.

We can produce the sequence {<span data-var="fullGeneratorList"> </span>} by raising <span data-var="fullGenerator"> </span> to successive powers (%% \bmod %% <span data-var="primeP"></span>). This is a _finite_ cyclic group because it wraps around such that %%g^{n} = g^0 = 1%%, %%g^{n+1} = g^1 = g%% and so on.

{.js-subgroup-example-possibly-broken}
One of the cyclic subgroups of %%\mathbb{Z}_p^*%% of prime order <span data-var="subgroupListOrder"> <span> </span></span> is {<span data-var="subgroupList"> </span>}, generated by <span data-var="subgroupGenerator"> </span>.

{.js-subgroup-example-possibly-broken}
All the elements of a subgroup can also act as generators. For example,
<span data-var="subgroupGenerator2"><span> </span> </span> generates the subgroup in a different order: {<span data-var="subgroupList2"> </span>}.

Read more about cyclic groups on <a href="http://en.wikipedia.org/wiki/Cyclic_group" target="_blank">Wikipedia</a>.

~~~

## Encrypting and Decrypting with ElGamal

Alice wants to enable people to send secret messages to her, so she creates a *public key* %%(p,g,y)%% that she shares with the world and a *private key* %%x%% that she never rveals to anyone else. Bob wants to send Alice a secret message, so he uses Alice's public key and a one-time *ephemeral key* %%k%% to produce the encrypted *ciphertext* %%(u,v)%%. Here's how it works:

~~~ {.example}

## ElGamal: How Does it Work?

{.alice-column-start} ![Alice](images/Alice.svg)

{.bob-column-start} ![Bob](images/Bob.svg)

{.alice-column} Choose a prime number %%p%%.

{.alice-column} Choose an integer %%g%% in %%\mathbb{Z}_p^*%% that generates a cyclic subgroup of %%\mathbb{Z}_p^*%% of order %%n%%.

{.alice-column} Choose a private key %%x%% such that %%1 \leq x \leq n-1%%.

{.alice-column} Find %%y = g^x \pmod{p}%%.

{.alice-column.send-right} Publish the public key %%(p,g,y)%%.

{.bob-column} Look at Alice's public key %%(p,g,y)%%.

{.bob-column} Choose a random integer %%k%% such that %%1 \leq k \leq n-1%%. Note that this means that Bob needs to know %%n%% in order to send a message.

{.bob-column} Determine %%m%% such that %%1 \leq m \leq p-1%%. If the full message is too long, split up the message into chunks in order to encrypt them separately.

{.bob-column} Compute %%u = g^k \pmod{p}%%.

{.bob-column} Compute %%v = m y^k \pmod{p}%%.

{.bob-column.send-left} Publish the ciphertext %%(u,v)%%.

{.alice-column} Look at Bob's ciphertext %%(u,v)%%.

{.alice-column} Decrypt the message with %%m = u^{-x} v \pmod{p}%%.

~~~

## Meet in the Middle: Attacking Alice Inc.

![Eve](images/Eve.svg)
While Alice and Bob have been exchanging secrets, Eve has been feeling left out. In order to make her happy, lets explore one of the ways that Eve can read Bob's messages to Alice: the _Meet in the Middle Attack_. The _Meet in the Middle Attack_ is very different from the <a href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack" target="_blank"><em>Man in the Middle Attack</em></a> which involves Eve pretending to be Alice and Bob, reading messages that Bob encrypts with her key instead of Alice's and sending the messages to Alice after encrypting them with Alice's key.

If a number of conditions are met and the message %%m%% Bob sends Alice is short enough, Eve can recover %%m%% if she can intercept %%v%% as Bob sends his ciphertext to Alice. Specifically, the _Meet in the Middle Attack_ only works if

* %%m%% consists of at most %%b%% bits, Eve knows %%b%%, and %%b%% is small. This is not unreasonable if Eve knows that Bob is purchasing something from Alice Inc. and wants to send the company a %%54%% bit credit card number, for example.

* %%m%% can be factored into two parts such that %%m = (m_1)(m_2)%%. Let %%m_1%% consist of %%b_1%% bits and %%m_2%% consist of %%b_2%% bits.

* Eve knows %%n%%. Since Bob's ephemeral key %%k%% has the property %%1 \leq k \leq n-1%%, he also needs to determine %%n%% somehow. If he can, Eve can, too.

* %%m%% happens not to be an element of the subgroup generated by %%g%%. This seems quite unlikely. However, according to the thesis <a href="http://www.math.iastate.edu/thesisarchive/MST/AllenBMSTF08.pdf" target="_blank">Implementing several attacks on plain ElGamal encryption</a>, %%n%%, the order %%n%% of the subgroup generated by %%g%%, is frequently chosen to be small for efficiency reasons.

* The order %%n%% of the subgroup generated by %%g%% has the property that %% n \leq (p-1)2^{-b} %%. Again, it is possible that %%n%% is small for efficiency reasons.

### Mathematical Theory

If all the assumptions are met, Eve can proceed as follows:

She knows that

$$y = g^x \pmod{p}$$

and that

{.center-example}
%%v = my^k \pmod{p}%%.

Raising both sides to %%n%%,

{.center-example}
%%v^n = (m^n)(y^{kn}) \pmod{p}%%.

This is useless as part of an attack if %%m%% is an element of the subgroup generated by %%g%% because then %%m^n = 1%% (since all the elements of a subgroup generate that subgroup, albeit in a different order, and wrap around to %%1%% once they are raised to the order of the subgroup).

If that is not the case, however, remember that %%g^n = g^0 = 1%% because the subgroup generated by %%g%% is cyclic, so

$$ y^{kn} = g^{xkn} = (g^{n})^{xk} = 1^{xk} = 1 $$

which simplifies %%(m^n)(y^{kn})%% substantially:

{.center-example}
%%v^n = m^n \pmod{p}%%.

Using the assumption that %%m = (m_1)(m_2)%%,

$$v^n = (m_1^n)(m_2^n) \pmod{p}$$

{.center-example}
%%(v^n)(m_2^{-n}) = m_1^n \pmod{p}%%.

~~~ {.example}

## Dictionaries: More than Outdated Reference Books

To implement the _Meet in the Middle Attack_, Eve will need to use _dictionaries_ -- the computer science ones.

A traditional dictionary is organized so that it is very easy to look up a word to find its definition. The reverse -- looking for a definition in order to match it to a word -- is really time consuming, especially as the amount of entries in the dictionary grows.

----------------------------------------------------------- {.centered.bordered.rows.alt}
|    Word            |  Definition                        |
|--------------------|------------------------------------|
| Dictionary         | What this is.                      |
| Eve                | The coolest hacker on the planet.  |
| Meet in the Middle | Eve's favorite attack.             |
| ...                | ...                                |
-----------------------------------------------------------

A computer science dictionary is very similar, and it can even be used for the same purpose. The only difference is that the element to look up is called a _key_ and the element stored under that key is called a _value_.

----------------------------------------------------------- {.centered.bordered.rows.alt}
|    Key             |  Value                             |
|--------------------|------------------------------------|
| Dictionary         | What this is.                      |
| Eve                | The coolest hacker on the planet.  |
| Meet in the Middle | Eve's favorite attack.             |
| ...                | ...                                |
-----------------------------------------------------------

~~~

### The Attack in Practice

With the theory out of the way, we can finally help Eve with her attack:

~~~ {.example.js-attack-example}

## Running the Attack



Given that the prime %%p%% has <span class="TKAdjustableNumber" data-var="pBits" data-min="8" data-max="128"></span> bits,

<button class="graphite-flat-button js-attack-example-pick-p">Click to pick a random p</button>

The public key might be:

( %%p = %% <span data-var="primeP"></span>,

  %%g = %% <span data-var="generatorG"></span>,

  %%y = g^x \pmod{p} = %% <span data-var="valueY"></span> )

<!-- the factors of %%p-1%% are  -->
where the order of the subgroup generated by %%g%% is %%n=%% <span data-var="orderN"></span>,

and the private key might be:
%%x = %% <span data-var="keyX"></span>

Assuming that %%b = %% <span class="TKAdjustableNumber" data-var="bBits" data-min="8" data-max="64"></span> bits and that %%b_1 = %% <span class="TKAdjustableNumber" data-var="b1Bits" data-min="2" data-max="64"></span> bits meaning that %%b_2=%% <span data-var="b2Bits"><span> </span> </span> bits,

<button class="graphite-flat-button js-attack-example-pick-m">Click to pick a random m</button>

%%m = %% <span data-var="messageM"></span>

If the ephemeral key %%k%% is <span data-var="keyK"></span>, the ciphertext is:

( %%u = %% <span data-var="ciphertextU"></span>,

  %%v = %% <span data-var="ciphertextV"></span> )

1. For all %%m_1=1,...,2^{b_1}%%, create a dictionary mapping from %%m_1^n \pmod{p} \to m_1%%

2. For all %%m_2=1,...,2^{b_2}%%, compute %%v^n m_2^{-n} \pmod{p}%% and look it up in the dictionary.

3. If we find a match in the dictionary, we have found a solution %%(m_1,m_2)%% to %%(v^n)(m_2^{-n}) = m_1^n \pmod{p}%% and %%m%% is probably equal to %%(m_1)(m_2)%%.

Since the dictionary only depends on the public key %%(p,g,y)%% and the length of the message %%b%%, we can use it again. Notably, it doesn't depend on the ephemeral key %%k%% in any way.

Using the _Meet in the Middle Attack_, Eve guesses that %%m = %% <span data-var="eveGuessM"></span>.

~~~


## Resources

* <a href="http://www.math.iastate.edu/thesisarchive/MST/AllenBMSTF08.pdf" target="_blank">Implementing several attacks on plain ElGamal encryption</a>
* <a href="http://www.cs.colorado.edu/~srirams/classes/doku.php/pollard_rho_tutorial" target="_blank">A Quick Tutorial on Pollard's Rho Algorithm</a>
* <a href="http://blog.renzuocheng.com/2012/11/generate-cyclic-group-of-prime-order-and-one-of-its-generator/" target="_blank">Generate cyclic group of prime order and one of its generator</a>
* <a href="http://www.cc.gatech.edu/~aboldyre/teaching/F11cs6260/numbertheory.pdf" target="_blank">CS 6260: Some number theory</a>
* <a href="http://en.wikipedia.org/wiki/Multiplicative_order" target="_blank">Wikipedia: Multiplicative order</a>
* <a href="http://en.wikipedia.org/wiki/Cyclic_group" target="_blank">Wikipedia: Cyclic group</a>
* <a href="http://en.wikipedia.org/wiki/Group_(mathematics)" target="_blank">Wikipedia: Group (mathematics)</a>
* <a href="http://en.wikipedia.org/wiki/Multiplicative_group_of_integers_modulo_n" target="_blank">Wikipedia: Multiplicative group of integers modulo n</a>
* <a href="http://en.wikipedia.org/wiki/Pollard's_rho_algorithm" target="_blank">Wikipedia: Pollard's rho algorithm</a>

### Special Thanks to the Creators of

* <a href="www.leemon.com/crypto/BigInt.html" target="_blank">www.leemon.com/crypto/BigInt.html</a>
* <a href="http://worrydream.com/Tangle/" target="_blank">http://worrydream.com/Tangle/</a>
* <a href="http://requirejs.org/" target="_blank">http://requirejs.org/</a>
* <a href="http://rhojs.org" target="_blank">http://rhojs.org</a>